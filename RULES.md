# RULES

## 工作目标
在本项目中，优先保障需求清晰、架构稳健、交付可维护，避免过早实现与过度设计。

## 执行规则
1. 先文档后代码：未完成需求与架构确认前，不进入业务代码开发。
2. 小步更新：每次只做可审阅的小变更，并等待关键方向确认。
3. 保守演进：优先选成熟方案，不追新技术热点。
4. 接口先行：实现前先定义数据模型与 API 合约。
5. 显式假设：遇到不确定项先记录假设并请求确认。
6. 可回滚：任何结构性调整都要保证可回退。
7. 不破坏现状：不做与当前目标无关的重构。
8. 不生成无关代码：仅在明确同意后进入编码阶段。
9. 配置优先：新增外部依赖（URL/API key/model）必须先设计配置项。

## 质量规则
1. 文档可维护：术语一致、边界清楚、避免歧义。
2. 决策可追踪：重要技术决策必须记录到 `DECISIONS.md`。
3. 状态可同步：阶段推进必须更新 `SESSION_STATE.md`。
4. 范围要克制：V1 只做已确认范围，新增需求进入待评估清单。
5. 安全基线：示例配置不得包含真实密钥，默认走环境变量。

## 文档同步规则（增强）
1. 功能行为变更后，至少同步更新：`SESSION_STATE.md`、`README.md`、`DECISIONS.md`。
2. 涉及目标或约束变化时，同步更新：`PROJECT.md`、`ARCHITECTURE.md`。
3. 六个核心文档中的阶段描述与下一步规划必须保持口径一致。
4. `README.md` 作为部署与运维真源文档（single source of truth）。

## 上线前后验证规则
1. 变更前验证：
   - `docker compose ps`
   - `curl -I http://localhost:5173`
   - `curl -sS http://localhost:8000/api/v1/health`
2. 变更后验证：
   - 页面可访问且核心交互可用（地图、预警、曲线）
   - 日志无持续异常（`web/api/worker`）
3. 验证失败时必须记录回滚方案并更新 `SESSION_STATE.md`。

## 开发效率规则
1. 前端开发默认使用 `npm run dev` 热更新，避免频繁 `docker compose up --build`。
2. 仅在依赖变更时执行 `npm install` 或镜像重建。
3. 推荐使用 `dev.sh` / `dev-stop.sh` 统一启动与停止开发环境，避免端口冲突与残留容器。

## 演示与生产分离规则
1. 演示数据必须显式标识（例如 source 为 `MockScenario`）。
2. 生产环境禁止无感知回退到 mock；是否开启需策略化配置并可追踪。

## 交互一致性规则
1. 省份联动以 `selectedLocation` 为单一事实源：下拉、地图点击、预警点击、自选点都必须收敛到同一状态。
2. 地图点击省份默认触发联动刷新；地图自选位置模式用于额外回填经纬度。
3. 当前省份高亮固定为“仅边界高亮”，不得覆盖风险填充色语义。
4. 固定边界图例必须常驻显示，避免反选后语义丢失。
5. 图钉位置由 `selectedLocation` 单一事实源驱动，避免多源状态冲突。

## 协作规则
1. 需要确认的点必须先确认再推进。
2. 涉及范围/架构变化时，先给出影响再执行。
3. 未获确认，不修改既定目标与约束。
