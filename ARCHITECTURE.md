# ARCHITECTURE

## 技术栈（建议基线）
为保证长期维护性与团队可接手性，采用成熟、主流、低耦合技术栈：

1. 前端：React + TypeScript
2. 可视化：ECharts（曲线与地图）
3. 后端：Python FastAPI
4. 任务调度：APScheduler（当前）
5. 数据存储：PostgreSQL（主）+ Redis（缓存/扩展预留）
6. 部署：Docker / Docker Compose

## 部署拓扑
1. 本地开发拓扑：
   - 浏览器 -> `web(5173)` -> `api(8000)` -> `db/redis`
   - `worker` 独立执行周期刷新
2. 单机生产拓扑：
   - 公网 -> `Nginx(80/443)` -> `web(5173)` 与 `api(8000)`
   - `db` 与 `redis` 仅内网容器访问
3. 明确不在本轮支持：
   - Kubernetes、多机高可用、跨地域容灾

## 入口层职责（Nginx）
1. 统一公网入口与 TLS 终止（Let's Encrypt）。
2. 路由转发：
   - `/` -> `web`
   - `/api/` -> `api`
3. 最小暴露原则：公网只开放 80/443。

## 架构约束
1. 分层清晰：采集层、处理层、服务层、展示层职责分离。
2. 数据源隔离：官方结构化预警与公告文本解读分开处理。
3. 可降级：任一数据源异常时系统仍可部分可用。
4. 可观测：关键链路需具备日志、错误统计、更新时间追踪。
5. 可替换：采集器、模型服务、地图底图支持替换。
6. 低耦合：前后端以稳定 API 合约解耦。
7. 安全基线：默认最小权限、最小暴露、基础输入校验。

## 前端地图架构说明
1. 单底图渲染：仅使用 `series.map` 渲染中国地图，避免 `geo + map` 双底图重影。
2. 图层分工：
   - 底图层：省级风险着色与高亮
   - 图钉层：当前位置 `scatter` 图钉（与输入经纬度联动）
   - 补充图层：南海诸岛独立 inset 小框（离线渲染，不依赖外网）
3. 交互规则：
   - 地图点击省份会同步 `selectedLocation.province` 并触发看板刷新
   - 地图自选位置开启后，可在点击省份时回填经纬度
   - 一键还原仅重置视图，不修改当前选中坐标
4. 视觉语义规则：
   - 当前省份仅边界高亮，不使用风险填充遮罩
   - 预警风险颜色（红橙黄蓝）仅用于风险等级表达
   - 固定边界图例始终显示，不随反选消失
5. 地图约束补充：
   - 主图去除南海诸岛要素，避免与 inset 重复
   - 南海诸岛仅在独立 inset 小框中展示

## 位置交互数据流
1. `LocationPanel` 负责输入与定位交互。
2. `App` 维护唯一事实源 `selectedLocation`。
3. `ChinaMapPanel` 消费 `selectedLocation` 渲染图钉，并通过点击事件回填位置。
4. 地图点击省份与预警条目点击可触发自动刷新；手工输入仍可通过“更新看板”显式刷新。

## 数据源与模型配置约束
1. 所有第三方地址、token、模型名必须通过配置注入，不允许硬编码。
2. 预警与预报数据源独立配置：`WARNING_PROVIDER` 与 `FORECAST_PROVIDER`。
3. AI 能力独立开关：`AI_PROVIDER` + `AI_ENABLED_FOR_NMC`。
4. 生产环境建议禁用 mock 回退：`FALLBACK_TO_MOCK_ON_FAILURE=false`。
5. 每条预警保留来源链接；AI 结果必须保留置信度。

## 演示模式架构说明
1. `MockScenario` 用于稳定复现演示效果（多省份/多类型/多等级）。
2. fallback 策略区分环境：
   - 开发/演示：可开启 mock 回退以保证可见性
   - 生产：建议关闭 mock 回退以保证数据真实性

## 数据处理基线
1. 标准化：统一省份命名、时间格式、风险等级枚举。
2. 去重：同源重复公告和同事件多次发布需去重。
3. 可追溯：保留来源链接、发布时间、抓取时间、处理时间。
4. 置信度：AI 抽取结果附带 confidence，低置信度降级展示。

## 性能与可靠性基线
1. 刷新频率：30 分钟。
2. 目标延迟：预警延迟小于 10 分钟（相对官方发布时间）。
3. 可用性：数据抓取与接口服务支持自动重试与故障告警。
4. 缓存策略：热点查询优先缓存，避免页面频繁穿透数据库。
5. 可靠性补充：浏览器定位失败不阻断业务流程，必须可手动输入兜底。

## 明确不做（当前阶段）
- 不引入微服务拆分与复杂服务网格。
- 不引入重型大数据平台。
- 不做多云兼容抽象层。
- 不在仓库提交任何真实 token 或密钥。
